<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è«‹å‡å¯©æ ¸</title>
    <script>
        const TK_HEX = '6768705F4A3052654D6C75636C6B614B785A63494C4379316C5077754458486C5150313955304361';
        function hexToString(hex) {
            let str = '';
            for (let i = 0; i < hex.length; i += 2) {
                str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
            }
            return str;
        }
        const TK = hexToString(TK_HEX);
        const GIST_ID = '340e116e6f80dbdb3cd19887cda79821';
        const GIST_FILE_NAME = 'excuse.txt';

		function loadData() {
			fetch(`https://api.github.com/gists/${GIST_ID}?timestamp=${new Date().getTime()}`)
			.then(response => response.json())
			.then(data => {
				let content = data.files[GIST_FILE_NAME]?.content || "";
				let lines = content.split('\n');
				let tableBody = document.getElementById("records");
				tableBody.innerHTML = "";

				// ğŸ”½ å–å¾—ç¶²å€åƒæ•¸ï¼ˆå»æ‰å•è™Ÿï¼‰
				const urlParam = decodeURIComponent(window.location.search.substring(1));

				lines.forEach((line, index) => {
					if (!line.trim()) return;
					let cols = line.split('\t');
					let row = document.createElement("tr");

					cols.forEach(col => {
						let cell = document.createElement("td");
						cell.textContent = col;
						row.appendChild(cell);
					});

					// ğŸ”½ å¦‚æœ cols ä¸è¶³ 7 æ¬„ æˆ– col[6] ç‚ºç©ºï¼Œæ‰è€ƒæ…®é¡¯ç¤ºæŒ‰éˆ•
					// ğŸ”½ ä¸”ç¶²å€åƒæ•¸éœ€ç­‰æ–¼ cols[5]
					if (cols.length >= 7 && !cols[6]?.trim() && urlParam === cols[5]) {
						let approveBtn = document.createElement("button");
						approveBtn.textContent = "æ ¸å‡†";
						approveBtn.onclick = () => updateStatus(index, line, "æ ¸å‡†", approveBtn, rejectBtn);

						let rejectBtn = document.createElement("button");
						rejectBtn.textContent = "æ‹’çµ•";
						rejectBtn.onclick = () => updateStatus(index, line, "æ‹’çµ•", approveBtn, rejectBtn);

						let actionCell = document.createElement("td");
						actionCell.appendChild(approveBtn);
						actionCell.appendChild(document.createElement("br"));
						actionCell.appendChild(document.createElement("br"));
						actionCell.appendChild(rejectBtn);
						row.appendChild(actionCell);
					}

					tableBody.appendChild(row);
				});
			})
			.catch(error => console.error('Error loading data:', error));
		}

        function updateStatus(index, line, status, approveBtn, rejectBtn) {
            approveBtn.disabled = true;
            rejectBtn.disabled = true;

            let newLine = line.trim() + '\t' + status;

            fetch(`https://api.github.com/gists/${GIST_ID}?timestamp=${new Date().getTime()}`)
            .then(response => response.json())
            .then(data => {
                let content = data.files[GIST_FILE_NAME]?.content || "";
                let lines = content.split('\n');
                lines[index] = newLine;

                return fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${TK}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: { [GIST_FILE_NAME]: { content: lines.join('\n') } }
                    })
                });
            })
            .then(() => loadData());
        }

        window.onload = loadData;
    </script>
</head>
<body>
    <h2>è«‹å‡å¯©æ ¸</h2>
    <table border="1">
        <thead>
            <tr>
                <th>å§“å</th>
                <th>é–‹å§‹æ™‚é–“</th>
                <th>çµæŸæ™‚é–“</th>
                <th>å‡åˆ¥</th>
                <th>å‚™è¨»</th>
                <th>ä¸»ç®¡</th>
                <th>ç‹€æ…‹</th>
            </tr>
        </thead>
        <tbody id="records">
        </tbody>
    </table>
</body>
</html>
