<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>請假審核系統</title>
    <script>
        const TK_HEX = '6768705F4A3052654D6C75636C6B614B785A63494C4379316C5077754458486C5150313955304361';
        function hexToString(hex) {
            let str = '';
            for (let i = 0; i < hex.length; i += 2) {
                str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
            }
            return str;
        }
        const TK = hexToString(TK_HEX);
        const GIST_ID = '2385af75e322ffc9d58c986af8f198b9';
        const GIST_FILE_NAME = 'excuse.txt';
        
        function loadLeaveRecords() {
            fetch(`https://api.github.com/gists/${GIST_ID}`)
            .then(response => response.json())
            .then(data => {
                let content = data.files[GIST_FILE_NAME]?.content || "";
                let lines = content.split('\n').filter(line => line.trim() !== "");
                let halfYearAgo = new Date();
                halfYearAgo.setMonth(halfYearAgo.getMonth() - 6);
                
                let recordList = document.getElementById("recordList");
                recordList.innerHTML = "";
                
                let newLines = [];
                lines.forEach((line, index) => {
                    let parts = line.split('\t');
                    if (parts.length < 3) return;
                    let name = parts[0];
                    let startTime = new Date(parts[1]);
                    let endTime = parts[2];
                    let status = parts[3] || "";
                    
                    if (startTime < halfYearAgo) return;
                    newLines.push(line);
                    
                    let div = document.createElement("div");
                    div.innerHTML = `<b>${name}</b> ${parts[1]} ~ ${endTime} ${status}`;
                    
                    if (!status) {
                        let approveBtn = document.createElement("button");
                        approveBtn.innerText = "核准";
                        approveBtn.onclick = () => updateStatus(index, "核准");
                        
                        let rejectBtn = document.createElement("button");
                        rejectBtn.innerText = "拒絕";
                        rejectBtn.onclick = () => updateStatus(index, "拒絕");
                        
                        div.appendChild(approveBtn);
                        div.appendChild(rejectBtn);
                    }
                    
                    recordList.appendChild(div);
                });
            })
            .catch(error => console.error("讀取失敗:", error));
        }
        
        function updateStatus(index, status) {
            fetch(`https://api.github.com/gists/${GIST_ID}`)
            .then(response => response.json())
            .then(data => {
                let content = data.files[GIST_FILE_NAME]?.content || "";
                let lines = content.split('\n');
                if (index >= 0 && index < lines.length) {
                    lines[index] = lines[index].trim() + `\t${status}`;
                    let updatedContent = lines.join('\n');
                    
                    return fetch(`https://api.github.com/gists/${GIST_ID}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${TK}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            files: { [GIST_FILE_NAME]: { content: updatedContent } }
                        })
                    });
                }
            })
            .then(() => {
                loadLeaveRecords();
            })
            .catch(error => console.error("更新失敗:", error));
        }
        
        window.onload = loadLeaveRecords;
    </script>
</head>
<body>
    <h2>請假審核系統</h2>
    <div id="recordList">載入中...</div>
</body>
</html>
