<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE æ‰“å¡ç³»çµ±</title>
    <script>
        const TK_HEX = '6768705F4A3052654D6C75636C6B614B785A63494C4379316C5077754458486C5150313955304361';
        const GIST_ID = '128158194ad773c072ca111b84286cfb';
        const GIST_FILE_NAME = 'checkin.txt';
        const TK = hexToString(TK_HEX);
		const fetchOptions = {};
		fetchOptions.headers = {"Authorization": `token ${TK}`, "Accept": "application/vnd.github+json"};
	const ALLOWED_LOCATIONS = [
	  { name: "å°åŒ—å…¬å¸", lat: 24.986794380363925, lon: 121.5336918999006, radiusM: 200 },
	  { name: "å°ä¸­è¾¦å…¬å®¤", lat: 24.310777911896015, lon: 120.72138183688088, radiusM: 2000 },
	  { name: "åé‡Œç¾å…‰", lat: 24.318140260826873, lon: 120.72406839843525, radiusM: 2000 },
	];
	
	// è¨ˆç®—å…©é»é–“è·é›¢ï¼ˆHaversine å…¬å¼ï¼Œå›å‚³å…¬å°ºï¼‰
	function distance(lat1, lon1, lat2, lon2) {
	  const R = 6371e3; // åœ°çƒåŠå¾‘ (å…¬å°º)
	  const toRad = deg => deg * Math.PI / 180;
	
	  const dLat = toRad(lat2 - lat1);
	  const dLon = toRad(lon2 - lon1);
	  const lat1Rad = toRad(lat1);
	  const lat2Rad = toRad(lat2);
	
	  const a = Math.sin(dLat / 2) ** 2 +
	            Math.cos(lat1Rad) * Math.cos(lat2Rad) *
	            Math.sin(dLon / 2) ** 2;
	  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
	  return R * c; // å…¬å°º
	}
	
	// åˆ¤æ–·æ˜¯å¦åœ¨å…è¨±åœ°é»çš„å…è¨±è·é›¢å…§
	function isWithinAllowedArea(lat, lon) {
	  for (const loc of ALLOWED_LOCATIONS) {
	    const d = distance(lat, lon, loc.lat, loc.lon);
	    if (d <= loc.radiusM) {
	      return `${loc.name} ${Math.round(d)} å…¬å°º`;
	    }
	  }
	  return null; // âŒ ä¸åœ¨ä»»ä½•å…è¨±åœ°é»ç¯„åœå…§
	}

        function hexToString(hex) {
            let str = '';
            for (let i = 0; i < hex.length; i += 2)
                str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
            return str;
        }

	function isLine() {
	    return /Line/i.test(navigator.userAgent);
	}
	
	function isAndroid() {
	    return /Android/i.test(navigator.userAgent);
	}
	
	function openExternalBrowserAndroid(url) {
	    // å˜—è©¦é€é Intent é–‹å•Ÿå¤–éƒ¨ç€è¦½å™¨ï¼ˆChrome ç‚ºä¾‹ï¼‰
	    location.href = `intent://${url.replace(/^https?:\/\//, '')}#Intent;scheme=https;package=com.android.chrome;end`;
	}
	
	function checkEntry() {
	    if (!isLine() && !isAndroid()) {
	        document.body.innerHTML = "<p style='color:red;'>è«‹ç”± LINE é–‹å•Ÿæœ¬é é¢</p>";
	        return;
	    }
	
	    if (isAndroid() && isLine()) {
		 document.body.innerHTML = `
	          <div style="text-align:center; padding:40px; font-size:18px;">
	            <p>ğŸ“æœ¬æ‰“å¡ç³»çµ±éœ€ä½¿ç”¨ GPS<br>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œæ”¹ç”¨æ‰‹æ©Ÿç€è¦½å™¨é–‹å•Ÿ</p>
	            <a href="javascript:openExternalBrowserAndroid('https://ambercoltd.github.io/CheckIn');"
	               style="display:inline-block; margin-top:20px; padding:12px 24px; background:#007AFF; color:white; text-decoration:none; border-radius:8px;">
	              ğŸ‘‰ Androidè«‹é»é€™é–‹å•Ÿ
	            </a>
	          </div>
	        `;
	    }else{
	        fetchLocation(); // ä½ çš„å®šä½æµç¨‹
	    }
	}

        function fetchLocation() {
            if (!navigator.geolocation) {
                document.getElementById("locationStatus").innerText = "ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†ä½ç½®åŠŸèƒ½ã€‚";
                return;
            }

            navigator.geolocation.getCurrentPosition(async position => {
		    const { latitude: lat, longitude: lon } = position.coords;
		    localStorage.setItem('latitude', lat);
		    localStorage.setItem('longitude', lon);
		
		    let where = isWithinAllowedArea(lat, lon);
		
		    if (where == null) {
		        try {
		            let res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
		            let data = await res.json();
		            where = data.display_name || "ç„¡æ³•å–å¾—åœ°å€";
		        } catch (e) {
		            where = "åœ°å€å–å¾—å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚";
		        }
		    }
		
		    localStorage.setItem('address', where);
		    document.getElementById("locationStatus").innerText = where;
		
		    await sendLocation();
		}, error => {
		    document.getElementById("locationStatus").innerText = "ç„¡æ³•ç²å–ä½ç½®ï¼š" + error.message;
		});

        }

        function askForTel() {
            let tel = localStorage.getItem('tel');
            if (!tel || !/^\d{10}$/.test(tel)) {
                tel = prompt("è«‹è¼¸å…¥æ‚¨çš„10ç¢¼é›»è©±è™Ÿç¢¼ï¼š");
                if (tel && /^\d{10}$/.test(tel)) {
                    localStorage.setItem('tel', tel);
                } else {
                    alert("è¼¸å…¥çš„é›»è©±æ ¼å¼éŒ¯èª¤ã€‚");
                    return null;
                }
            }
            return tel;
        }

        async function sendLocation() {
		
            const tel = askForTel();
            if (!tel) return;

            const address = localStorage.getItem('address');

            if (!address) {
                alert("å°šæœªç²å–ä½ç½®è³‡è¨Šï¼Œè«‹ç¨å€™å†è©¦ã€‚");
                return;
            }

            await updateGist(tel, address);
        }

async function updateGist(tel, address) {
            const now = new Date();
            const formattedTime = `${now.getFullYear()}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            const newContent = `050\t${formattedTime}\t${tel}\t${address}\r\n`;
        
            try {
				let res = await fetch(`https://api.github.com/gists/${GIST_ID}?timestamp=${Date.now()}`,fetchOptions);
				let gistData = await res.json();
        
                let existingContent = gistData.files[GIST_FILE_NAME]?.content || '';
                let lines = existingContent.split('\n').filter(line => line.trim() !== '');
        
                // è¨ˆç®—æ™‚é–“ç¯„åœï¼ˆ30 å¤©ï¼‰
                const oneMonthAgo = new Date();
                oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
        
                // éæ¿¾å‡ºæœ€è¿‘ 6 å€‹æœˆå…§çš„ç´€éŒ„ï¼ˆå­˜å…¥ Gistï¼‰
                let updatedLines = lines.filter(line => {
                    const parts = line.split('\t');
                    return parts.length > 1 && Date.parse(parts[1]) > Date.now() - 15552000000;
                }).map(line => line.trim()); // åœ¨é€™è£¡å°æ¯ä¸€è¡Œåš trim()
        
                // éæ¿¾å‡ºæœ€è¿‘ 1 å€‹æœˆå…§ç›¸åŒ tel çš„ç´€éŒ„ï¼ˆé¡¯ç¤ºåœ¨ logRecordsï¼‰
                let recentRecords = updatedLines.filter(line => {
                    const parts = line.split('\t');
                    return parts.length > 2 && parts[2] === tel && Date.parse(parts[1]) >= oneMonthAgo;
                });
        
                // æ’å…¥æ–°ç´€éŒ„åˆ° Gist
                updatedLines.unshift(newContent.trim());
        
                await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `token ${TK}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ files: { [GIST_FILE_NAME]: { content: updatedLines.join('\r\n') } } })
                });
        
                document.getElementById("status").innerText = "æ‰“å¡æˆåŠŸï¼";
                document.getElementById("logRecords").innerText = newContent + recentRecords.join('\r\n'); // åªé¡¯ç¤ºæœ€è¿‘ 1 å€‹æœˆçš„è¨˜éŒ„
            } catch (error) {
                alert("æ‰“å¡å¤±æ•—ï¼š" + error);
            }
        }


  async function tryUpdate(isRetry) {
    // 0) åŸºæœ¬é€£ç·šæ¸¬è©¦ï¼šèƒ½ä¸èƒ½æ‰“åˆ° GitHub APIï¼ˆä¸å¸¶ tokenï¼‰
    //    å¦‚æœé€™éƒ½å¤±æ•—ï¼Œå•é¡Œå°±ä¸æ˜¯è¡çªï¼Œè€Œæ˜¯ã€Œç¶²è·¯/ç’°å¢ƒã€å±¤ç´š
    try {
      log(`UA=${navigator.userAgent}`);
      const ping = await fetch("https://api.github.com/rate_limit", { cache: "no-store" });
      log(`PING /rate_limit â†’ ${ping.status} ${ping.statusText}`);
    } catch (e) {
      log(`PING ç›´æ¥å¤±æ•—ï¼š${e?.name || ""} ${e?.message || e}`);
      throw new Error("é€£ GitHub API éƒ½æ‰“ä¸åˆ°ï¼ˆç’°å¢ƒ/ç¶²è·¯å±¤å•é¡Œï¼‰");
    }

    // 1) è®€ Gistï¼ˆå–å¾—å…§å®¹ + ETagï¼‰
    const { res: getRes, json: gistData } = await fetchJson(
      `https://api.github.com/gists/${GIST_ID}?_=${Date.now()}`,
      {
        "Authorization": `token ${TK}`,
        "Accept": "application/vnd.github+json"
      }
    );

    // æ³¨æ„ï¼šåœ¨ç€è¦½å™¨è£¡ã€ŒæŸäº› header å¯èƒ½è®€ä¸åˆ°ã€(ä¾‹å¦‚ ETag æ²’ expose)
    // æˆ‘å€‘æœƒå°å‡ºæ‰€æœ‰å¯è®€ headers
    try {
      const hs = [];
      getRes.headers.forEach((v, k) => hs.push(`${k}: ${v}`));
      log(`GET headers(å¯è®€)=${hs.join(" | ")}`);
    } catch {}

    const etag = getRes.headers.get("ETag"); // å¯èƒ½æ˜¯ nullï¼ˆå¾ˆé‡è¦ï¼‰
    log(`ETag=${etag}`);

    const fileObj = gistData?.files?.[GIST_FILE_NAME];
    if (!fileObj) {
      log(`æ‰¾ä¸åˆ°æª”æ¡ˆï¼š${GIST_FILE_NAME}ã€‚gist files keys=${Object.keys(gistData?.files || {}).join(",")}`);
      throw new Error(`Gist è£¡æ²’æœ‰ ${GIST_FILE_NAME}ï¼ˆæª”åä¸å°æˆ– gist çµæ§‹ä¸åŒï¼‰`);
    }

    const existingContent = fileObj.content || "";
    let lines = existingContent.split(/\r?\n/).filter(l => l.trim() !== "");

    // 2) åªä¿ç•™ 6 å€‹æœˆå…§è³‡æ–™
    const sixMonthsAgo = Date.now() - 15552000000;
    lines = lines.filter(line => {
      const parts = line.split("\t");
      return parts.length > 1 && Date.parse(parts[1]) > sixMonthsAgo;
    });

    // 3) å–æœ€è¿‘ 1 å€‹æœˆåŒé›»è©±ï¼ˆé¡¯ç¤ºç”¨ï¼‰
    const oneMonthAgo = Date.now() - 2592000000;
    const recentRecords = lines.filter(line => {
      const parts = line.split("\t");
      return parts.length > 2 && parts[2] === tel && Date.parse(parts[1]) >= oneMonthAgo;
    });

    // 4) æ’å…¥æ–°è³‡æ–™åˆ°æœ€ä¸Šé¢
    lines.unshift(newLine);

    const newContent = lines.join("\r\n");

    // 5) PATCHï¼ˆè‹¥ ETag è®€ä¸åˆ°ï¼Œå°±å…ˆä¸å¸¶ If-Matchï¼›ä½†æœƒå¤±å»é˜²è¦†å¯«èƒ½åŠ›ï¼‰
    if (!etag) {
      log("âš ï¸ è®€ä¸åˆ° ETagï¼ˆå¯èƒ½è¢«ç€è¦½å™¨é™åˆ¶ header å­˜å–ï¼‰ã€‚å…ˆå˜—è©¦ä¸å¸¶ If-Match æ›´æ–°ï¼ˆå¯èƒ½ä»æœ‰è¦†å¯«é¢¨éšªï¼‰ã€‚");
    }

    const { res: patchRes } = await patchGist(etag, newContent);

    if (patchRes.status === 412) {
      // è¡çªï¼šæœ‰äººæ¯”ä½ å…ˆå¯«å…¥
      if (!isRetry) {
        log("412 è¡çª â†’ è‡ªå‹•é‡è©¦ä¸€æ¬¡");
        return await tryUpdate(true);
      }
      alert("âš ï¸ å‰›å‰›æœ‰äººåŒæ™‚æ‰“å¡ï¼Œè«‹é‡è©¦");
      return;
    }

    if (!patchRes.ok) {
      // å¸¸è¦‹ï¼š401 token éŒ¯ / 403 æ¬Šé™ä¸è¶³æˆ– rate limit / 413 å…§å®¹å¤ªå¤§
      alert("æ‰“å¡å¤±æ•—ï¼šGitHub å›æ‡‰é 200ï¼Œè«‹çœ‹ä¸‹æ–¹ debugLog");
      return;
    }

    // æˆåŠŸ
    document.getElementById("status").innerText = "âœ… æ‰“å¡æˆåŠŸï¼";
    document.getElementById("logRecords").innerText =
      newLine + "\r\n" + recentRecords.join("\r\n");
    log("âœ… å®Œæˆ");
  }

  try {
    await tryUpdate(false);
  } catch (e) {
    log(`âŒ æœ€å¤–å±¤éŒ¯èª¤ï¼š${e?.name || ""} ${e?.message || e}`);
    alert("æ‰“å¡å¤±æ•—ï¼ˆè«‹çœ‹ä¸‹æ–¹ debugLogï¼‰");
  }
}


        function clearTel() {
            const pwd = prompt("è«‹è¼¸å…¥å¯†ç¢¼ä»¥æ¸…é™¤é›»è©±è™Ÿç¢¼ï¼š");
            if (pwd === '20938096') {
                localStorage.removeItem('tel');
                document.getElementById("telStatus").innerText = "é›»è©±è™Ÿç¢¼å·²æ¸…é™¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚";
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•æ¸…é™¤ã€‚");
            }
        }

        window.onload = checkEntry;
    </script>
</head>
<body>
    <p id="status"></p>
    <p id="locationStatus">ä½ç½®ç²å–ä¸­...</p>
    <button onclick="clearTel()">æ›é›»è©±</button>
    <p id="telStatus"></p>
    <pre id="logRecords"></pre>
	<pre id="debugLog" style="white-space:pre-wrap; font-size:12px; background:#111; color:#0f0; padding:10px; border-radius:8px;"></pre>
</body>
</html>
