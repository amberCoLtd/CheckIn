<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LINE 打卡系統</title>
    <script>
        const TK = atob('Z2hwX3JobEtjdjFVMjRnSkdqQjVWMHJyYzRzZGQycm9FTzBMWWNWUA==');
        const GIST_ID = 'e040ce5991ea8f9f94be991261bd0afa';  // Gist ID
        
        function isLineBrowser() {
            return /Line/i.test(navigator.userAgent);
        }

        function checkBrowser() {
            fetchLocation();return;
            if (!isLineBrowser()) {
                window.location.href = "https://www.google.com";
            } else {
                fetchLocation(); // 只有在 LINE 瀏覽器中才抓取地址
            }
        }

        function fetchLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async function(position) {
                    let lat = position.coords.latitude;
                    let lon = position.coords.longitude;
                    localStorage.setItem('latitude', lat);
                    localStorage.setItem('longitude', lon);
                    localStorage.setItem('address', "");

                    try {
                        let response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                        let data = await response.json();
                        let address = data.display_name || "無法取得地址";
                        localStorage.setItem('address', address);
                        document.getElementById("locationStatus").innerText = "地址已取得: " + address;
                        document.getElementById("checkinImage").style.display = "block"; // 顯示打卡按鈕
                    } catch (error) {
                        document.getElementById("locationStatus").innerText = "無法取得地址請收後再試: " + error.message;
                    }
                }, function(error) {
                    document.getElementById("locationStatus").innerText = "無法獲取位置: " + error.message;
                });
            } else {
                document.getElementById("locationStatus").innerText = "您的瀏覽器不支援地理位置功能。";
            }
        }

        function askForTel() {
            let tel = localStorage.getItem('tel');
            if (!tel) {
                tel = prompt("請輸入您的電話號碼：");
                if (tel && /^\d{10}$/.test(tel)) {
                    localStorage.setItem('tel', tel);
                } else {
                    document.getElementById("status").innerText = "請輸入正確的 10 碼電話號碼。";
                    return null;
                }
            }
            return tel;
        }

        function sendLocation() {
            let tel = askForTel();
            if (tel === null) return;
            
            let lat = localStorage.getItem('latitude');
            let lon = localStorage.getItem('longitude');
            let address = localStorage.getItem('address');
            
            if (!lat || !lon || !address) {
                document.getElementById("status").innerText = "尚未獲取位置，請稍後再試。";
                return;
            }
            
            // 創建新的檔案，根據日期生成檔名
            const fileName = new Date().toISOString().slice(0, 10).replace(/-/g, '') + '.txt'; // 生成格式為 yyyyMMdd.txt
            
            // 更新 Gist 的內容
            updateGist(fileName, tel, address);
        }

        function updateGist(fileName, tel, address) {
            const time = new Date().toLocaleString();  // 取得當前時間
            const content = `050\t${time}\t${tel}\t${address}\n`;  // 按照要求的格式寫入

            fetch(`https://api.github.com/gists`, {
                method: 'POST',
                headers: {
                    'Authorization': `token ${TK}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: {
                        [fileName]: {
                            content: content
                        }
                    },
                    description: '打卡紀錄'
                })
            })
            .then(response => response.json())
            .then(data => {
                alert('打卡成功:', data);
            })
            .catch(error => {
                alert('打卡失敗:', error);
            });
        }

        function clearTel() {
            let password = prompt("請輸入密碼以清除電話號碼:");
            const correctPassword = "20938096";
            if (password === correctPassword) {
                localStorage.removeItem('tel');
                document.getElementById("telStatus").innerText = "已清除電話，打卡時重輸電話";
            } else {
                document.getElementById("telStatus").innerText = "密碼錯誤，無法清除電話號碼。";
            }
        }

        window.onload = checkBrowser;
    </script>
</head>
<body>
    <a href="#" onclick="sendLocation()">
        <img id="checkinImage" style="display: none;" src="checkin.png" />
    </a>
    <p id="status"></p>
    <p id="locationStatus">位置獲取中...</p>
    
    <button onclick="clearTel()">換電話</button>
    <p id="telStatus"></p>
</body>
</html>
