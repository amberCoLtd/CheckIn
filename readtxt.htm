<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ‰“å¡ç´€éŒ„æŸ¥è©¢</title>

<style>
body {
  font-family: sans-serif;
  padding: 20px;
}
h2 {
  margin-bottom: 10px;
}
button {
  padding: 8px 14px;
  font-size: 15px;
  margin-bottom: 10px;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
  font-size: 14px;
}
th {
  background: #f0f0f0;
}
tr:nth-child(even) {
  background: #fafafa;
}
tr.alert {
  background: #ffe3e3 !important;
}
#loading {
  font-size: 16px;
  color: #666;
  margin-bottom: 10px;
}
</style>
</head>

<body>

<h2>ğŸ“„ æœ€è¿‘ 60 å¤©æ‰“å¡ç´€éŒ„</h2>

<button onclick="downloadTxt()">â¬‡ï¸ ä¸‹è¼‰ TXT</button>

<div id="loading">è®€å–ä¸­...</div>

<table id="table" style="display:none">
  <thead>
    <tr>
      <th>æ™‚é–“</th>
      <th>é›»è©±</th>
      <th>åœ°é»</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script>
/* ========= è¨­å®š ========= */

const GIST_ID = "128158194ad773c072ca111b84286cfb";
const TK_HEX = "6768705F4A3052654D6C75636C6B614B785A63494C4379316C5077754458486C5150313955304361";

function hexToString(hex) {
  let s = '';
  for (let i = 0; i < hex.length; i += 2)
    s += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
  return s;
}
const TOKEN = hexToString(TK_HEX);

/* ========= ä¸»é‚è¼¯ ========= */

let recordCache = [];

function normalizeLocation(str) {
  // å°‡ã€Œå…¬å°ºã€è½‰æˆ m
  return str.replace(/å…¬å°º/g, "m");
}

function getDistanceFromText(text) {
  const match = text.match(/(\d+)\s*m/);
  return match ? parseInt(match[1], 10) : null;
}

async function loadAllRecords() {
  const res = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
    headers: {
      "Authorization": `token ${TOKEN}`,
      "Accept": "application/vnd.github+json"
    }
  });

  if (!res.ok) {
    document.getElementById("loading").innerText = "âŒ è®€å–å¤±æ•—";
    return;
  }

  const data = await res.json();
  const files = data.files;

  const now = Date.now();
  const DAYS_60 = 60 * 24 * 60 * 60 * 1000;

  let rows = [];

  for (const name in files) {
    if (!name.endsWith(".txt")) continue;

    const content = files[name].content || "";
    const lines = content.split("\n");

    for (const line of lines) {
      const parts = line.trim().split("\t");
      if (parts.length < 4) continue;

      const time = Date.parse(parts[1]);
      if (isNaN(time)) continue;

      if (now - time > DAYS_60) continue;

      const location = normalizeLocation(parts[3]);
      const dist = getDistanceFromText(location);

      const isAbnormal = (dist === null || dist > 3000);

      rows.push({
        time,
        timeText: parts[1],
        tel: parts[2],
        location,
        isAbnormal
      });
    }
  }

  // æ’åºï¼šç•°å¸¸åœ¨å‰ â†’ æ™‚é–“æ–°åˆ°èˆŠ
  rows.sort((a, b) => {
    if (a.isAbnormal !== b.isAbnormal)
      return a.isAbnormal ? -1 : 1;
    return b.time - a.time;
  });

  recordCache = rows;

  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  rows.forEach(r => {
    const tr = document.createElement("tr");
    if (r.isAbnormal) tr.classList.add("alert");

    tr.innerHTML = `
      <td>${r.timeText}</td>
      <td>${r.tel}</td>
      <td>${r.location}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("loading").style.display = "none";
  document.getElementById("table").style.display = "table";
}

/* ========= ä¸‹è¼‰ TXT ========= */

function downloadTxt() {
  if (!recordCache.length) {
    alert("æ²’æœ‰è³‡æ–™å¯ä¸‹è¼‰");
    return;
  }

  const text = recordCache
    .map(r => `050\t${r.timeText}\t${r.tel}\t${r.location}`)
    .join("\r\n");

  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `amber_${new Date().toISOString().slice(0,10)}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ========= å•Ÿå‹• ========= */
loadAllRecords();
</script>

</body>
</html>
